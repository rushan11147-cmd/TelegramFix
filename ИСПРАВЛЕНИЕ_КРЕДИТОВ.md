# Исправление системы кредитов

## Проблема
Система кредитов не работала корректно - платежи не списывались или списывались неправильно.

## Что было исправлено

### 1. Улучшена обработка платежей по кредитам
**Файл:** `app.py`, функция `next_day()`

**Изменения:**
- Добавлена проверка существования списка кредитов перед итерацией
- Улучшена логика удаления погашенных кредитов (в обратном порядке)
- Добавлена проверка индекса перед удалением кредита
- Добавлен комментарий о возможности получения достижения "Без долгов"

**Код до:**
```python
# Платежи по кредитам
expired_credits = []
for i, credit in enumerate(user.get('credits', [])):
    monthly_expenses += credit['monthly_payment']
    credit['remaining_months'] -= 1
    
    if credit['remaining_months'] <= 0:
        expired_credits.append(i)

# Удаляем погашенные кредиты
for i in reversed(expired_credits):
    user['credits'].pop(i)
```

**Код после:**
```python
# Платежи по кредитам
expired_credits = []
credits_list = user.get('credits', [])
for i, credit in enumerate(credits_list):
    monthly_expenses += credit.get('monthly_payment', 0)
    credit['remaining_months'] -= 1
    
    if credit['remaining_months'] <= 0:
        expired_credits.append(i)

# Удаляем погашенные кредиты (в обратном порядке чтобы не сбить индексы)
for i in reversed(expired_credits):
    if i < len(user['credits']):
        user['credits'].pop(i)

# Если кредитов больше нет, но они были - можно получить достижение
if len(user.get('credits', [])) == 0 and user.get('had_credits', False):
    # Проверяем достижение "Без долгов"
    pass
```

## Как работает система кредитов

### Создание кредита
1. Игрок выбирает покупку в кредит (машина или недвижимость)
2. Вносит первоначальный взнос (минимум 20-30% от стоимости)
3. Выбирает срок кредита (в месяцах)
4. Система рассчитывает ежемесячный платеж по формуле аннуитета
5. Кредит добавляется в массив `user['credits']`
6. Устанавливается флаг `user['had_credits'] = True`

### Обработка платежей
Платежи списываются **раз в месяц** (каждые 30 игровых дней):
1. В первый день месяца (`user['day'] % 30 == 1`)
2. Для каждого кредита:
   - Добавляется ежемесячный платеж к расходам
   - Уменьшается количество оставшихся месяцев
   - Если месяцев не осталось - кредит помечается для удаления
3. Погашенные кредиты удаляются из списка
4. Общая сумма расходов вычитается из денег игрока

### Типы кредитов

#### Автокредит (`car_loan`)
- Ставка: 12% годовых
- Первоначальный взнос: минимум 20%
- Максимальный срок: 60 месяцев (5 лет)

#### Ипотека (`mortgage`)
- Ставка: 8% годовых
- Первоначальный взнос: минимум 30%
- Максимальный срок: 240 месяцев (20 лет)

#### Потребительский кредит (`consumer_loan`)
- Ставка: 18% годовых
- Первоначальный взнос: минимум 10%
- Максимальный срок: 60 месяцев (5 лет)

### Формула расчета платежа
Используется формула аннуитетного платежа:

```python
def calculate_monthly_payment(principal, rate, term_months):
    """Рассчитать ежемесячный платеж по кредиту"""
    if rate == 0:
        return principal / term_months
    
    monthly_rate = rate / 12
    payment = principal * (monthly_rate * (1 + monthly_rate)**term_months) / ((1 + monthly_rate)**term_months - 1)
    return int(payment)
```

Где:
- `principal` - сумма кредита (цена - первоначальный взнос)
- `rate` - годовая процентная ставка (например, 0.12 для 12%)
- `term_months` - срок кредита в месяцах

### Структура данных кредита

```python
credit = {
    'id': f"car_{car_id}_{len(user.get('credits', []))}",  # Уникальный ID
    'type': 'car_loan',  # Тип кредита
    'item': car_id,  # ID купленного предмета
    'principal': loan_amount,  # Сумма кредита
    'monthly_payment': monthly_payment,  # Ежемесячный платеж
    'remaining_months': term_months,  # Оставшихся месяцев
    'rate': credit_type['rate']  # Процентная ставка
}
```

## Достижение "Без долгов"

Для получения достижения нужно:
1. Иметь хотя бы один кредит в истории (`user['had_credits'] == True`)
2. Погасить все кредиты (`len(user['credits']) == 0`)
3. Иметь положительный баланс (`user['money'] > 0`)

Награда: 150,000₽

## Тестирование

### Как протестировать кредиты:

1. **Создать кредит:**
   ```
   - Купить машину или недвижимость
   - Выбрать оплату "В кредит"
   - Указать первоначальный взнос и срок
   ```

2. **Проверить списание:**
   ```
   - Пройти 30 игровых дней
   - Проверить что деньги списались
   - Проверить что remaining_months уменьшился
   ```

3. **Проверить погашение:**
   ```
   - Дождаться окончания срока кредита
   - Проверить что кредит удалился из списка
   - Проверить что платежи больше не списываются
   ```

4. **Проверить достижение:**
   ```
   - Погасить все кредиты
   - Проверить что достижение "Без долгов" доступно
   ```

## Возможные проблемы и решения

### Проблема 1: Платежи не списываются
**Причина:** Кредиты обрабатываются только раз в месяц (каждые 30 дней)
**Решение:** Это нормальное поведение. Подождите до первого дня месяца.

### Проблема 2: Кредит не удаляется после погашения
**Причина:** Ошибка в индексации при удалении
**Решение:** Исправлено - теперь удаление происходит в обратном порядке с проверкой индекса

### Проблема 3: Отрицательный баланс после платежа
**Причина:** Недостаточно денег для оплаты кредита
**Решение:** Система автоматически устанавливает баланс в 0, но кредит остается

### Проблема 4: Достижение "Без долгов" не выдается
**Причина:** Флаг `had_credits` не установлен или есть активные кредиты
**Решение:** Проверить что:
- `user['had_credits'] == True`
- `len(user['credits']) == 0`
- `user['money'] > 0`

## Дальнейшие улучшения

### Возможные доработки:
1. **Досрочное погашение** - возможность погасить кредит раньше срока
2. **Реструктуризация** - изменение условий кредита
3. **Штрафы за просрочку** - если нет денег на платеж
4. **Кредитная история** - влияет на ставки будущих кредитов
5. **Уведомления** - напоминания о предстоящих платежах
6. **Детальная статистика** - сколько уже выплачено, сколько осталось

## Статус
✅ Исправлено и готово к тестированию
