<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–í—ã–∂–∏–≤–∏ –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .game-container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background 0.5s ease;
        }
        
        .game-header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .game-title {
            font-size: 24px;
            font-weight: 900;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 8px;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
        }
        
        .work-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5e6d8, #e8d5b7);
            backdrop-filter: blur(5px);
            position: relative;
            transition: background 0.5s ease;
        }
        
        .character-emoji {
            font-size: 120px;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .work-button {
            width: 250px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border: 3px solid #fff;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .work-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.6);
        }
        
        .work-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .motivational-text {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #ffa502;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 8px;
        }
        
        .bottom-section {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .energy-section {
            text-align: center;
        }
        
        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
            border: 2px solid #fff;
        }
        
        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #7bed9f);
            transition: width 0.3s;
            border-radius: 8px;
        }
        
        .energy-text {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .next-day-button {
            width: 100%;
            height: 45px;
            background: linear-gradient(135deg, #3742fa, #2f3542);
            border: 2px solid #fff;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .next-day-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(55, 66, 250, 0.4);
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            max-width: 280px;
            border: 3px solid #ff6b35;
        }
        
        .popup-emoji {
            font-size: 50px;
            margin-bottom: 12px;
        }
        
        .popup-text {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .popup-cost {
            font-size: 24px;
            font-weight: 900;
            color: #ff4757;
        }
        
        .popup-cost.positive {
            color: #2ed573;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç –ª–∏—á–Ω–æ—Å—Ç–∏ */
        .trait-selection {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 20px;
        }
        
        .trait-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .trait-header h2 {
            font-size: 24px;
            font-weight: 900;
            color: #ff6b35;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .trait-header p {
            font-size: 14px;
            color: #bdc3c7;
            font-weight: bold;
        }
        
        .traits-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }
        
        .trait-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ff6b35;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .trait-card:hover {
            background: rgba(255, 107, 53, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
        }
        
        .trait-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .trait-emoji {
            font-size: 40px;
            margin-right: 15px;
        }
        
        .trait-name {
            font-size: 20px;
            font-weight: 900;
            color: #fff;
        }
        
        .trait-description {
            font-size: 14px;
            color: #ecf0f1;
            line-height: 1.4;
            font-weight: bold;
        }
        
        .trait-display {
            font-size: 12px;
            color: #f39c12;
            font-weight: bold;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã */
        .job-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .current-job {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        
        .jobs-button, .shop-button {
            width: 100%;
            height: 40px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: 2px solid #fff;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .jobs-button:hover, .shop-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #2c3e50;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #ff6b35;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
            font-weight: 900;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .jobs-list, .boosters-list {
            padding: 20px;
        }
        
        .job-item, .booster-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .job-item:hover, .booster-item:hover {
            background: rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
            transform: translateY(-2px);
        }
        
        .job-item.locked, .booster-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .job-item.locked:hover, .booster-item.locked:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #34495e;
            transform: none;
        }
        
        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .item-emoji {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .item-name {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            flex: 1;
        }
        
        .item-income, .item-cost {
            font-size: 14px;
            font-weight: bold;
            color: #2ed573;
        }
        
        .item-cost {
            color: #ff6b35;
        }
        
        .item-description {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 5px;
        }
        
        .item-stats {
            font-size: 12px;
            color: #f39c12;
            margin-top: 5px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ */
        .shop-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫—Ä–µ–¥–∏—Ç–∞ */
        .item-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .payment-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .payment-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #34495e;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-btn.active {
            background: rgba(255, 107, 53, 0.3);
            border-color: #ff6b35;
        }
        
        .credit-details {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            color: #ecf0f1;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #34495e;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
        
        .form-group span {
            font-size: 12px;
            color: #f39c12;
            margin-top: 5px;
            display: block;
        }
        
        .credit-calculation {
            background: rgba(255, 107, 53, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ff6b35;
        }
        
        .buy-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #2ed573, #7bed9f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4);
        }
        
        .buy-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è */
        .item-owned {
            background: rgba(46, 213, 115, 0.2) !important;
            border-color: #2ed573 !important;
        }
        
        .item-owned .item-stats {
            color: #2ed573;
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç—ã –ª–∏—á–Ω–æ—Å—Ç–∏ -->
        <div class="trait-selection" id="traitSelection" style="display: none;">
            <div class="trait-header">
                <h2>–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —á–µ—Ä—Ç—É –ª–∏—á–Ω–æ—Å—Ç–∏</h2>
                <p>–ß–µ—Ä—Ç–∞ –±—É–¥–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –≤—Å—é –∏–≥—Ä—É –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞!</p>
            </div>
            <div class="traits-grid" id="traitsGrid">
                <!-- –ß–µ—Ä—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
        <div class="main-game" id="mainGame">
            <div class="game-header">
                <div class="game-title">–í—ã–∂–∏–≤–∏ –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã</div>
                <div class="game-stats">
                    <div>–î–µ–Ω—å: <span id="day">1</span> / <span id="maxDays">30</span></div>
                    <div>üí∞ –î–µ–Ω—å–≥–∏: <span id="money">500</span>‚ÇΩ</div>
                    <div class="trait-display" id="traitDisplay" style="display: none;">
                        <span id="traitEmoji"></span> <span id="traitName"></span>
                    </div>
                </div>
            </div>
        
        <div class="work-section" id="workSection">
            <div class="character-emoji" id="characterEmoji">‚òï</div>
            
            <!-- –í—ã–±–æ—Ä —Ä–∞–±–æ—Ç—ã -->
            <div class="job-selector" id="jobSelector">
                <div class="current-job" id="currentJob">
                    <span id="currentJobEmoji">üõµ</span>
                    <span id="currentJobName">–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</span>
                </div>
                <button class="jobs-button" id="jobsBtn">–°–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É üíº</button>
            </div>
            
            <button class="work-button" id="workBtn">–†–ê–ë–û–¢–ê–¢–¨! üë®‚Äçüíª</button>
            
            <div class="motivational-text" id="motivationalText">
                –î–æ–∂–∏—Ç—å –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã –∏ –Ω–µ —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å!
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="energy-section">
                <div class="energy-text">–≠–Ω–µ—Ä–≥–∏—è: <span id="energy">100</span> / <span id="maxEnergy">100</span></div>
                <div class="energy-bar">
                    <div class="energy-fill" id="energyFill" style="width: 100%"></div>
                </div>
            </div>
            
            <button class="next-day-button" id="nextDayBtn">–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å üåÖ</button>
            
            <div class="shop-buttons">
                <button class="shop-button" id="shopBtn">–ë—É—Å—Ç–µ—Ä—ã üõí</button>
                <button class="shop-button" id="carsBtn">–ú–∞—à–∏–Ω—ã üöó</button>
                <button class="shop-button" id="realEstateBtn">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å üè†</button>
            </div>
        </div>
        </div>
    </div>
    
    <div class="popup" id="eventPopup">
        <div class="popup-emoji" id="popupEmoji"></div>
        <div class="popup-text" id="popupText"></div>
        <div class="popup-cost" id="popupCost"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã -->
    <div class="modal" id="jobsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–í—ã–±–µ—Ä–∏ —Ä–∞–±–æ—Ç—É</h3>
                <button class="close-btn" id="closeJobsModal">&times;</button>
            </div>
            <div class="jobs-list" id="jobsList">
                <!-- –†–∞–±–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ú–∞–≥–∞–∑–∏–Ω –±—É—Å—Ç–µ—Ä–æ–≤</h3>
                <button class="close-btn" id="closeShopModal">&times;</button>
            </div>
            <div class="boosters-list" id="boostersList">
                <!-- –ë—É—Å—Ç–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—à–∏–Ω -->
    <div class="modal" id="carsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</h3>
                <button class="close-btn" id="closeCarsModal">&times;</button>
            </div>
            <div class="cars-list" id="carsList">
                <!-- –ú–∞—à–∏–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
    <div class="modal" id="realEstateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h3>
                <button class="close-btn" id="closeRealEstateModal">&times;</button>
            </div>
            <div class="real-estate-list" id="realEstateList">
                <!-- –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫—Ä–µ–¥–∏—Ç–∞ -->
    <div class="modal" id="creditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="creditModalTitle">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞</h3>
                <button class="close-btn" id="closeCreditModal">&times;</button>
            </div>
            <div class="credit-form" id="creditForm">
                <div class="item-info" id="creditItemInfo"></div>
                <div class="payment-options">
                    <button class="payment-btn active" id="cashBtn">–ù–∞–ª–∏—á–Ω—ã–µ üí∞</button>
                    <button class="payment-btn" id="creditBtn">–ö—Ä–µ–¥–∏—Ç üè¶</button>
                </div>
                <div class="credit-details" id="creditDetails" style="display: none;">
                    <div class="form-group">
                        <label>–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å:</label>
                        <input type="number" id="downPayment" min="0">
                        <span id="minDownPayment"></span>
                    </div>
                    <div class="form-group">
                        <label>–°—Ä–æ–∫ (–º–µ—Å—è—Ü–µ–≤):</label>
                        <input type="number" id="termMonths" min="12" max="300" value="24">
                    </div>
                    <div class="credit-calculation" id="creditCalculation"></div>
                </div>
                <button class="buy-btn" id="confirmPurchase">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        console.log('Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω:', !!window.Telegram?.WebApp);
        console.log('User Agent:', navigator.userAgent);
        console.log('Screen size:', window.screen.width + 'x' + window.screen.height);
        
        let userId = 'demo_user';
        let gameData = {};
        let traits = {};
        let jobs = {};
        let boosters = {};
        let cars = {};
        let realEstate = {};
        let creditTypes = {};
        let currentPurchaseItem = null;
        let currentPurchaseType = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
            document.body.style.backgroundColor = tg.backgroundColor || '#1a1a2e';
            
            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser && tgUser.id) {
                userId = tgUser.id.toString();
                console.log('Telegram User ID:', userId);
            } else {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                console.log('Demo User ID:', userId);
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                tg.close();
            });
        } else {
            console.log('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º demo —Ä–µ–∂–∏–º');
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function loadTraits() {
            try {
                const response = await fetch('/api/traits');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                traits = await response.json();
                displayTraits();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä—Ç:', error);
            }
        }
        
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                jobs = await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç:', error);
            }
        }
        
        async function loadBoosters() {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –±—É—Å—Ç–µ—Ä—ã...');
                const response = await fetch('/api/boosters');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                boosters = await response.json();
                console.log('–ë—É—Å—Ç–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', boosters);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—É—Å—Ç–µ—Ä–æ–≤:', error);
            }
        }
        
        async function loadCars() {
            try {
                const response = await fetch('/api/cars');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                cars = await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—à–∏–Ω:', error);
            }
        }
        
        async function loadRealEstate() {
            try {
                const response = await fetch('/api/real_estate');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                realEstate = await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏:', error);
            }
        }
        
        async function loadCreditTypes() {
            try {
                const response = await fetch('/api/credit_types');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                creditTypes = await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –∫—Ä–µ–¥–∏—Ç–æ–≤:', error);
            }
        }
        
        function displayTraits() {
            const traitsGrid = document.getElementById('traitsGrid');
            traitsGrid.innerHTML = '';
            
            Object.keys(traits).forEach(traitId => {
                const trait = traits[traitId];
                const traitCard = document.createElement('div');
                traitCard.className = 'trait-card';
                traitCard.onclick = () => selectTrait(traitId);
                
                traitCard.innerHTML = `
                    <div class="trait-card-header">
                        <div class="trait-emoji">${trait.emoji}</div>
                        <div class="trait-name">${trait.name}</div>
                    </div>
                    <div class="trait-description">${trait.description}</div>
                `;
                
                traitsGrid.appendChild(traitCard);
            });
        }
        
        async function selectTrait(traitId) {
            try {
                const response = await fetch('/api/select_trait', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_id: userId,
                        trait_id: traitId
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                gameData = result.user;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–≥—Ä—ã
                await loadJobs();
                await loadBoosters();
                await loadCars();
                await loadRealEstate();
                await loadCreditTypes();
                
                // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
                document.getElementById('traitSelection').style.display = 'none';
                document.getElementById('mainGame').style.display = 'block';
                
                updateUI();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç—ã:', error);
            }
        }
        
        async function loadUser() {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
                const response = await fetch(`/api/user/${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                gameData = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', gameData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —á–µ—Ä—Ç–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
                if (!gameData.trait_selected) {
                    console.log('–ß–µ—Ä—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç
                    document.getElementById('traitSelection').style.display = 'block';
                    document.getElementById('mainGame').style.display = 'none';
                    await loadTraits();
                } else {
                    console.log('–ß–µ—Ä—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–≥—Ä—É
                    document.getElementById('traitSelection').style.display = 'none';
                    document.getElementById('mainGame').style.display = 'block';
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —á–µ—Ä—Ç—ã
                    await loadTraits();
                    await loadJobs();
                    await loadBoosters();
                    await loadCars();
                    await loadRealEstate();
                    await loadCreditTypes();
                    updateUI();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                gameData = {
                    money: 500,
                    day: 1,
                    max_days: 30,
                    energy: 100,
                    max_energy: 100,
                    money_per_work: 50,
                    last_event: null,
                    last_event_time: 0,
                    salary: 25000,
                    trait: null,
                    trait_selected: false,
                    current_job: 'delivery',
                    unlocked_jobs: ['delivery'],
                    boosters: {},
                    owned_items: [],
                    cars: [],
                    real_estate: [],
                    credits: [],
                    monthly_income: 0,
                    monthly_expenses: 0
                };
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–µ—Ä—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                document.getElementById('traitSelection').style.display = 'block';
                document.getElementById('mainGame').style.display = 'none';
                await loadTraits();
                await loadJobs();
                await loadBoosters();
                await loadCars();
                await loadRealEstate();
                await loadCreditTypes();
            }
        }
        
        function showJobsModal() {
            const jobsList = document.getElementById('jobsList');
            jobsList.innerHTML = '';
            
            Object.keys(jobs).forEach(jobId => {
                const job = jobs[jobId];
                const isUnlocked = gameData.unlocked_jobs && gameData.unlocked_jobs.includes(jobId);
                const isCurrent = gameData.current_job === jobId;
                
                const jobItem = document.createElement('div');
                jobItem.className = `job-item ${!isUnlocked ? 'locked' : ''} ${isCurrent ? 'current' : ''}`;
                
                if (isUnlocked && !isCurrent) {
                    jobItem.onclick = () => changeJob(jobId);
                }
                
                jobItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-emoji">${job.emoji}</div>
                        <div class="item-name">${job.name}</div>
                        <div class="item-income">+${job.base_income}‚ÇΩ</div>
                    </div>
                    <div class="item-description">${job.description}</div>
                    <div class="item-stats">–≠–Ω–µ—Ä–≥–∏—è: -${job.energy_cost} | ${isUnlocked ? (isCurrent ? '–¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞' : '–î–æ—Å—Ç—É–ø–Ω–æ') : `–û—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞ ${job.unlock_day} –¥–µ–Ω—å`}</div>
                `;
                
                jobsList.appendChild(jobItem);
            });
            
            document.getElementById('jobsModal').style.display = 'flex';
        }
        
        function showShopModal() {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–∞–≥–∞–∑–∏–Ω');
            console.log('–ë—É—Å—Ç–µ—Ä—ã:', boosters);
            console.log('–î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞:', gameData);
            
            const boostersList = document.getElementById('boostersList');
            boostersList.innerHTML = '';
            
            if (!boosters || Object.keys(boosters).length === 0) {
                boostersList.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –±—É—Å—Ç–µ—Ä–æ–≤...</div>';
                document.getElementById('shopModal').style.display = 'flex';
                return;
            }
            
            Object.keys(boosters).forEach(boosterId => {
                const booster = boosters[boosterId];
                const canAfford = gameData.money >= booster.cost;
                const isOwned = gameData.owned_items && gameData.owned_items.includes(boosterId);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –¥–ª—è —á–µ—Ä—Ç—ã "–≠–∫–æ–Ω–æ–º–Ω—ã–π"
                let cost = booster.cost;
                if (gameData.trait === '—ç–∫–æ–Ω–æ–º–Ω—ã–π') {
                    cost = Math.floor(cost * 0.9);
                }
                
                const boosterItem = document.createElement('div');
                boosterItem.className = `booster-item ${!canAfford ? 'locked' : ''} ${isOwned ? 'owned' : ''}`;
                
                if (canAfford && !isOwned) {
                    boosterItem.onclick = () => buyBooster(boosterId);
                }
                
                boosterItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-emoji">${booster.emoji}</div>
                        <div class="item-name">${booster.name}</div>
                        <div class="item-cost">${cost}‚ÇΩ</div>
                    </div>
                    <div class="item-description">${booster.description}</div>
                    <div class="item-stats">${isOwned ? '–ö—É–ø–ª–µ–Ω–æ' : (canAfford ? '–î–æ—Å—Ç—É–ø–Ω–æ' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥')}</div>
                `;
                
                boostersList.appendChild(boosterItem);
            });
            
            document.getElementById('shopModal').style.display = 'flex';
        }
        
        function showCarsModal() {
            const carsList = document.getElementById('carsList');
            carsList.innerHTML = '';
            
            if (!cars || Object.keys(cars).length === 0) {
                carsList.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—à–∏–Ω...</div>';
                document.getElementById('carsModal').style.display = 'flex';
                return;
            }
            
            Object.keys(cars).forEach(carId => {
                const car = cars[carId];
                const isOwned = gameData.cars && gameData.cars.includes(carId);
                
                const carItem = document.createElement('div');
                carItem.className = `job-item ${isOwned ? 'item-owned' : ''}`;
                
                if (!isOwned) {
                    carItem.onclick = () => showCreditModal(carId, 'car');
                }
                
                carItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-emoji">${car.emoji}</div>
                        <div class="item-name">${car.name}</div>
                        <div class="item-cost">${car.price.toLocaleString()}‚ÇΩ</div>
                    </div>
                    <div class="item-description">${car.description}</div>
                    <div class="item-stats">
                        ${isOwned ? '–í —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏' : `–î–æ—Ö–æ–¥ +${Math.round(car.income_bonus * 100)}% | –†–∞—Å—Ö–æ–¥—ã: ${car.monthly_cost}‚ÇΩ/–º–µ—Å`}
                    </div>
                `;
                
                carsList.appendChild(carItem);
            });
            
            document.getElementById('carsModal').style.display = 'flex';
        }
        
        function showRealEstateModal() {
            const realEstateList = document.getElementById('realEstateList');
            realEstateList.innerHTML = '';
            
            if (!realEstate || Object.keys(realEstate).length === 0) {
                realEstateList.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏...</div>';
                document.getElementById('realEstateModal').style.display = 'flex';
                return;
            }
            
            Object.keys(realEstate).forEach(propertyId => {
                const property = realEstate[propertyId];
                const isOwned = gameData.real_estate && gameData.real_estate.includes(propertyId);
                
                const propertyItem = document.createElement('div');
                propertyItem.className = `job-item ${isOwned ? 'item-owned' : ''}`;
                
                if (!isOwned) {
                    propertyItem.onclick = () => showCreditModal(propertyId, 'real_estate');
                }
                
                const monthlyNet = property.monthly_income - Math.abs(property.monthly_cost);
                
                propertyItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-emoji">${property.emoji}</div>
                        <div class="item-name">${property.name}</div>
                        <div class="item-cost">${property.price.toLocaleString()}‚ÇΩ</div>
                    </div>
                    <div class="item-description">${property.description}</div>
                    <div class="item-stats">
                        ${isOwned ? '–í —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏' : `–î–æ—Ö–æ–¥: ${monthlyNet > 0 ? '+' : ''}${monthlyNet}‚ÇΩ/–º–µ—Å | ${property.type === 'residential' ? '–ñ–∏–ª–∞—è' : '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è'}`}
                    </div>
                `;
                
                realEstateList.appendChild(propertyItem);
            });
            
            document.getElementById('realEstateModal').style.display = 'flex';
        }
        
        function showCreditModal(itemId, itemType) {
            currentPurchaseItem = itemId;
            currentPurchaseType = itemType;
            
            const item = itemType === 'car' ? cars[itemId] : realEstate[itemId];
            const creditType = itemType === 'car' ? creditTypes.car_loan : creditTypes.mortgage;
            
            document.getElementById('creditModalTitle').textContent = 
                itemType === 'car' ? '–ü–æ–∫—É–ø–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è' : '–ü–æ–∫—É–ø–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏';
            
            document.getElementById('creditItemInfo').innerHTML = `
                <div class="item-header">
                    <div class="item-emoji">${item.emoji}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-cost">${item.price.toLocaleString()}‚ÇΩ</div>
                </div>
                <div class="item-description">${item.description}</div>
            `;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã –∫—Ä–µ–¥–∏—Ç–∞
            const minDown = Math.floor(item.price * creditType.min_down_payment);
            document.getElementById('downPayment').min = minDown;
            document.getElementById('downPayment').value = minDown;
            document.getElementById('minDownPayment').textContent = `–ú–∏–Ω–∏–º—É–º: ${minDown.toLocaleString()}‚ÇΩ`;
            document.getElementById('termMonths').max = creditType.max_term;
            
            // –°–±—Ä–æ—Å –∫ –Ω–∞–ª–∏—á–Ω—ã–º
            document.getElementById('cashBtn').classList.add('active');
            document.getElementById('creditBtn').classList.remove('active');
            document.getElementById('creditDetails').style.display = 'none';
            
            updateCreditCalculation();
            document.getElementById('creditModal').style.display = 'flex';
        }
        
        function updateCreditCalculation() {
            if (!currentPurchaseItem || !currentPurchaseType) return;
            
            const item = currentPurchaseType === 'car' ? cars[currentPurchaseItem] : realEstate[currentPurchaseItem];
            const creditType = currentPurchaseType === 'car' ? creditTypes.car_loan : creditTypes.mortgage;
            const isCredit = document.getElementById('creditBtn').classList.contains('active');
            
            if (!isCredit) {
                document.getElementById('confirmPurchase').textContent = `–ö—É–ø–∏—Ç—å –∑–∞ ${item.price.toLocaleString()}‚ÇΩ`;
                return;
            }
            
            const downPayment = parseInt(document.getElementById('downPayment').value) || 0;
            const termMonths = parseInt(document.getElementById('termMonths').value) || 24;
            const loanAmount = item.price - downPayment;
            
            if (loanAmount <= 0) {
                document.getElementById('creditCalculation').innerHTML = '–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞: 0‚ÇΩ';
                document.getElementById('confirmPurchase').textContent = `–ö—É–ø–∏—Ç—å –∑–∞ ${downPayment.toLocaleString()}‚ÇΩ`;
                return;
            }
            
            const monthlyRate = creditType.rate / 12;
            const monthlyPayment = Math.floor(loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1));
            const totalPayment = monthlyPayment * termMonths;
            const overpayment = totalPayment - loanAmount;
            
            document.getElementById('creditCalculation').innerHTML = `
                <div>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞: ${loanAmount.toLocaleString()}‚ÇΩ</div>
                <div>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: ${monthlyPayment.toLocaleString()}‚ÇΩ</div>
                <div>–ü–µ—Ä–µ–ø–ª–∞—Ç–∞: ${overpayment.toLocaleString()}‚ÇΩ</div>
                <div>–°—Ç–∞–≤–∫–∞: ${Math.round(creditType.rate * 100)}% –≥–æ–¥–æ–≤—ã—Ö</div>
            `;
            
            document.getElementById('confirmPurchase').textContent = `–ö—É–ø–∏—Ç—å (–≤–∑–Ω–æ—Å: ${downPayment.toLocaleString()}‚ÇΩ)`;
        }
        
        async function changeJob(jobId) {
            try {
                const response = await fetch('/api/change_job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_id: userId,
                        job_id: jobId
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                gameData = result.user;
                updateUI();
                document.getElementById('jobsModal').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–∞–±–æ—Ç—ã:', error);
            }
        }
        
        async function buyBooster(boosterId) {
            try {
                const response = await fetch('/api/buy_booster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_id: userId,
                        booster_id: boosterId
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                gameData = result.user;
                updateUI();
                showShopModal(); // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ
                alert(`–ö—É–ø–ª–µ–Ω–æ: ${result.booster.name} –∑–∞ ${result.cost}‚ÇΩ`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ –±—É—Å—Ç–µ—Ä–∞:', error);
            }
        }
        
        async function confirmPurchase() {
            if (!currentPurchaseItem || !currentPurchaseType) return;
            
            const isCredit = document.getElementById('creditBtn').classList.contains('active');
            const downPayment = parseInt(document.getElementById('downPayment').value) || 0;
            const termMonths = parseInt(document.getElementById('termMonths').value) || 24;
            
            const endpoint = currentPurchaseType === 'car' ? '/api/buy_car' : '/api/buy_real_estate';
            const paymentType = isCredit ? (currentPurchaseType === 'car' ? 'credit' : 'mortgage') : 'cash';
            
            try {
                const requestData = {
                    user_id: userId,
                    [currentPurchaseType === 'car' ? 'car_id' : 'property_id']: currentPurchaseItem,
                    payment_type: paymentType
                };
                
                if (isCredit) {
                    requestData.down_payment = downPayment;
                    requestData.term_months = termMonths;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                gameData = result.user;
                updateUI();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('creditModal').style.display = 'none';
                document.getElementById('carsModal').style.display = 'none';
                document.getElementById('realEstateModal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const item = currentPurchaseType === 'car' ? cars[currentPurchaseItem] : realEstate[currentPurchaseItem];
                let message = `–ö—É–ø–ª–µ–Ω–æ: ${item.name}`;
                
                if (isCredit) {
                    message += `\n–í–∑–Ω–æ—Å: ${result.down_payment?.toLocaleString() || downPayment.toLocaleString()}‚ÇΩ`;
                    message += `\n–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: ${result.monthly_payment?.toLocaleString()}‚ÇΩ`;
                } else {
                    message += `\n–°—Ç–æ–∏–º–æ—Å—Ç—å: ${result.cost?.toLocaleString()}‚ÇΩ`;
                }
                
                alert(message);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∫—É–ø–∫—É
                currentPurchaseItem = null;
                currentPurchaseType = null;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
            }
        }
        
        async function work() {
            if (gameData.energy <= 0) {
                alert('–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏! –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é.');
                return;
            }
            
            try {
                const response = await fetch('/api/work', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(result.error);
                    return;
                }
                
                gameData = result.user;
                updateUI();
                
                if (result.event) {
                    showEvent(result.event);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã:', error);
            }
        }
        
        async function nextDay() {
            try {
                const response = await fetch('/api/next_day', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const result = await response.json();
                gameData = result.user;
                updateUI();
                
                if (result.salary_received) {
                    alert(result.message);
                } else if (result.message) {
                    alert(result.message);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é:', error);
            }
        }
        
        function updateUI() {
            document.getElementById('day').textContent = gameData.day;
            document.getElementById('maxDays').textContent = gameData.max_days;
            document.getElementById('money').textContent = gameData.money;
            document.getElementById('energy').textContent = gameData.energy;
            document.getElementById('maxEnergy').textContent = gameData.max_energy;
            
            const energyPercent = (gameData.energy / gameData.max_energy) * 100;
            document.getElementById('energyFill').style.width = `${energyPercent}%`;
            
            const workBtn = document.getElementById('workBtn');
            workBtn.disabled = gameData.energy <= 0;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —á–µ—Ä—Ç—É
            if (gameData.trait && traits[gameData.trait]) {
                const traitDisplay = document.getElementById('traitDisplay');
                const traitEmoji = document.getElementById('traitEmoji');
                const traitName = document.getElementById('traitName');
                
                traitEmoji.textContent = traits[gameData.trait].emoji;
                traitName.textContent = traits[gameData.trait].name;
                traitDisplay.style.display = 'block';
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—Ç—É
            if (gameData.current_job && jobs[gameData.current_job]) {
                const currentJob = jobs[gameData.current_job];
                document.getElementById('currentJobEmoji').textContent = currentJob.emoji;
                document.getElementById('currentJobName').textContent = currentJob.name;
            }
            
            updateBackground();
        }
        
        function updateBackground() {
            const workSection = document.getElementById('workSection');
            const characterEmoji = document.getElementById('characterEmoji');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ü–µ–Ω—É –∏ —ç–º–æ–¥–∑–∏
            if (gameData.energy < 30) {
                // –í–µ—á–µ—Ä - —É—Å—Ç–∞–ª
                workSection.style.background = 'linear-gradient(135deg, #4a4a4a, #333333)';
                characterEmoji.textContent = 'üç∫';
            } else if (gameData.day <= 10) {
                // –£—Ç—Ä–æ –¥–æ–º–∞
                workSection.style.background = 'linear-gradient(135deg, #f5e6d8, #e8d5b7)';
                characterEmoji.textContent = '‚òï';
            } else if (gameData.day <= 20) {
                // –ù–∞ —Ä–∞–±–æ—Ç–µ
                workSection.style.background = 'linear-gradient(135deg, #f5f5f5, #e0e0e0)';
                characterEmoji.textContent = 'üíª';
            } else {
                // –ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä
                workSection.style.background = 'linear-gradient(135deg, #4a4a4a, #333333)';
                characterEmoji.textContent = 'üò¥';
            }
        }
        
        function showEvent(event) {
            document.getElementById('popupEmoji').textContent = event.emoji;
            document.getElementById('popupText').textContent = event.text;
            
            const costElement = document.getElementById('popupCost');
            const cost = event.cost;
            costElement.textContent = cost > 0 ? `+${cost}‚ÇΩ` : `${cost}‚ÇΩ`;
            costElement.className = cost > 0 ? 'popup-cost positive' : 'popup-cost';
            
            document.getElementById('eventPopup').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('eventPopup').style.display = 'none';
            }, 3000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('workBtn').addEventListener('click', work);
        document.getElementById('nextDayBtn').addEventListener('click', nextDay);
        document.getElementById('jobsBtn').addEventListener('click', showJobsModal);
        document.getElementById('shopBtn').addEventListener('click', async () => {
            console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –º–∞–≥–∞–∑–∏–Ω–∞');
            if (!boosters || Object.keys(boosters).length === 0) {
                console.log('–ë—É—Å—Ç–µ—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º...');
                await loadBoosters();
            }
            showShopModal();
        });
        document.getElementById('carsBtn').addEventListener('click', async () => {
            if (!cars || Object.keys(cars).length === 0) {
                await loadCars();
            }
            showCarsModal();
        });
        document.getElementById('realEstateBtn').addEventListener('click', async () => {
            if (!realEstate || Object.keys(realEstate).length === 0) {
                await loadRealEstate();
            }
            showRealEstateModal();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.getElementById('closeJobsModal').addEventListener('click', () => {
            document.getElementById('jobsModal').style.display = 'none';
        });
        
        document.getElementById('closeShopModal').addEventListener('click', () => {
            document.getElementById('shopModal').style.display = 'none';
        });
        
        document.getElementById('closeCarsModal').addEventListener('click', () => {
            document.getElementById('carsModal').style.display = 'none';
        });
        
        document.getElementById('closeRealEstateModal').addEventListener('click', () => {
            document.getElementById('realEstateModal').style.display = 'none';
        });
        
        document.getElementById('closeCreditModal').addEventListener('click', () => {
            document.getElementById('creditModal').style.display = 'none';
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        document.getElementById('jobsModal').addEventListener('click', (e) => {
            if (e.target.id === 'jobsModal') {
                document.getElementById('jobsModal').style.display = 'none';
            }
        });
        
        document.getElementById('shopModal').addEventListener('click', (e) => {
            if (e.target.id === 'shopModal') {
                document.getElementById('shopModal').style.display = 'none';
            }
        });
        
        document.getElementById('carsModal').addEventListener('click', (e) => {
            if (e.target.id === 'carsModal') {
                document.getElementById('carsModal').style.display = 'none';
            }
        });
        
        document.getElementById('realEstateModal').addEventListener('click', (e) => {
            if (e.target.id === 'realEstateModal') {
                document.getElementById('realEstateModal').style.display = 'none';
            }
        });
        
        document.getElementById('creditModal').addEventListener('click', (e) => {
            if (e.target.id === 'creditModal') {
                document.getElementById('creditModal').style.display = 'none';
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã
        document.getElementById('cashBtn').addEventListener('click', () => {
            document.getElementById('cashBtn').classList.add('active');
            document.getElementById('creditBtn').classList.remove('active');
            document.getElementById('creditDetails').style.display = 'none';
            updateCreditCalculation();
        });
        
        document.getElementById('creditBtn').addEventListener('click', () => {
            document.getElementById('creditBtn').classList.add('active');
            document.getElementById('cashBtn').classList.remove('active');
            document.getElementById('creditDetails').style.display = 'block';
            updateCreditCalculation();
        });
        
        document.getElementById('downPayment').addEventListener('input', updateCreditCalculation);
        document.getElementById('termMonths').addEventListener('input', updateCreditCalculation);
        document.getElementById('confirmPurchase').addEventListener('click', confirmPurchase);
        
        document.getElementById('eventPopup').addEventListener('click', () => {
            document.getElementById('eventPopup').style.display = 'none';
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadUser();
    </script>
</body>
</html>