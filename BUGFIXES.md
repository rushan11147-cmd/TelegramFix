# Исправленные баги в игре "Выживи до зарплаты"

## Дата исправления: 27 января 2026

### 1. ✅ Критический баг: Неполная обработка черты "Рисковый" (app.py, строка ~917)
**Проблема:** Код обрывался на строке с `trait_data['negative_event_multiplier']` - не хватало присваивания значения.

**Исправление:**
```python
# Было:
if user.get('trait') == 'рисковый' and event_cost < 0:
    trait_data = TRAITS['рисковый']

# Стало:
if user.get('trait') == 'рисковый' and event_cost < 0:
    trait_data = TRAITS['рисковый']
    event_cost = int(event_cost * trait_data['negative_event_multiplier'])
```

**Последствия:** Черта "Рисковый" не работала корректно - негативные события не усиливались.

---

### 2. ✅ Баг: Неправильное списание денег при покупке машины за наличные (app.py, ~640)
**Проблема:** При покупке машины за наличные списывался `down_payment` вместо полной цены `cost`.

**Исправление:**
```python
# Было:
user['money'] -= down_payment

# Стало:
user['money'] -= cost
```

**Последствия:** Игроки могли покупать машины бесплатно или за неправильную цену.

---

### 3. ✅ Баг: Неправильный расчет пассивного дохода (app.py, ~1007)
**Проблема:** Пассивный доход рассчитывался каждый день, но применялся только раз в месяц, что приводило к путанице.

**Исправление:**
```python
# Было:
# Пассивный доход от недвижимости
passive_income = 0
for property_id in user.get('real_estate', []):
    if property_id in REAL_ESTATE:
        passive_income += REAL_ESTATE[property_id]['monthly_income']

# Ежемесячные расходы (в начале каждого месяца)
monthly_expenses = 0
if user['day'] % 30 == 1:
    # расчет расходов...

# Стало:
# Ежемесячные расходы и доходы (в начале каждого месяца)
passive_income = 0
monthly_expenses = 0

if user['day'] % 30 == 1:  # Первый день месяца
    # Пассивный доход от недвижимости
    for property_id in user.get('real_estate', []):
        if property_id in REAL_ESTATE:
            passive_income += REAL_ESTATE[property_id]['monthly_income']
    # расчет расходов...
```

**Последствия:** Пассивный доход отображался некорректно в сообщениях.

---

### 4. ✅ Баг: Отсутствие проверки инициализации поля 'unlocked_jobs' (app.py, ~457)
**Проблема:** Использование `user['unlocked_jobs']` без проверки существования могло вызвать KeyError.

**Исправление:**
```python
# Было:
if job_id not in user['unlocked_jobs']:

# Стало:
if job_id not in user.get('unlocked_jobs', []):
```

**Последствия:** Возможные ошибки при смене работы для новых пользователей.

---

### 5. ✅ Баг: Отсутствие инициализации массивов перед append (app.py, множество мест)
**Проблема:** Попытка добавления элементов в несуществующие массивы могла вызвать AttributeError.

**Исправление:** Добавлены проверки перед всеми операциями append:
- `unlocked_jobs` (строки ~501, ~995)
- `owned_items` (строка ~507)
- `boosters` (строка ~511)
- `cars` (строки ~646, ~683)
- `real_estate` (строки ~749, ~783)

```python
# Пример исправления:
if 'cars' not in user:
    user['cars'] = []
user['cars'].append(car_id)
```

**Последствия:** Возможные критические ошибки при покупке предметов, машин и недвижимости.

---

## Итого исправлено: 5 критических багов

### Рекомендации для дальнейшего тестирования:
1. ✅ Протестировать выбор черты "Рисковый" и проверить усиление негативных событий
2. ✅ Протестировать покупку машин за наличные
3. ✅ Протестировать пассивный доход от недвижимости
4. ✅ Протестировать смену работы для нового пользователя
5. ✅ Протестировать покупку всех типов предметов, машин и недвижимости

### Статус игры: ✅ Готова к тестированию

Все критические баги исправлены. Игра должна работать стабильно.
