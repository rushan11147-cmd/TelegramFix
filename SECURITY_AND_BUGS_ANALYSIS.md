# –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–∞–≥–æ–≤

–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 28 —è–Ω–≤–∞—Ä—è 2026

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. Race Conditions –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ
**–ö–æ–¥:**
```python
users_data = {}  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –±–µ–∑ –∑–∞—â–∏—Ç—ã
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Gunicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤, –∫–∞–∂–¥—ã–π —Å —Å–≤–æ–∏–º –∫—ç—à–µ–º `users_data`

**–ë–∞–≥:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π:** 
- –Æ–∑–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –≤–æ—Ä–∫–µ—Ä–µ 1 
- –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ—Ä–∫–µ—Ä 2 ‚Üí —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Ç–µ—Ä—è–Ω

**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å –∫—ç—à –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è shared state

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 2. –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –≤–æ–∑–º–æ–∂–Ω—ã
**–ö–æ–¥:**
```python
user['money'] -= cost  # –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –≤—ã—á–∏—Ç–∞–Ω–∏—è
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `buy_car`, `buy_real_estate` –¥–µ–Ω—å–≥–∏ –º–æ–≥—É—Ç —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –£ —é–∑–µ—Ä–∞ 1000‚ÇΩ
- –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É –ø–æ 800‚ÇΩ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `if user['money'] < cost`
- –û–±–∞ –≤—ã—á–∏—Ç–∞—é—Ç 800‚ÇΩ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: -600‚ÇΩ

**–†–µ—à–µ–Ω–∏–µ:** 
```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã—á–∏—Ç–∞–Ω–∏—è
user['money'] -= cost
if user['money'] < 0:
    user['money'] += cost
    return error

# –í–∞—Ä–∏–∞–Ω—Ç 2: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 3. –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —á–µ—Ä–µ–∑ race condition
**–ö–æ–¥:**
```python
if user['energy'] < energy_cost:
    return error
user['energy'] -= energy_cost
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –≠–Ω–µ—Ä–≥–∏—è 10
- –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ 10 —ç–Ω–µ—Ä–≥–∏–∏
- –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û–±–∞ –≤—ã—á–∏—Ç–∞—é—Ç 10
- –†–µ–∑—É–ª—å—Ç–∞—Ç: -10 —ç–Ω–µ—Ä–≥–∏–∏

**–†–µ—à–µ–Ω–∏–µ:** –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 4. SQL Injection –≤ PostgreSQL
**–ö–æ–¥:**
```python
cursor.execute('SELECT data FROM users WHERE user_id = %s', (user_id,))
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–ù–æ:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `user_id` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞—É–¥–∏—Ç–∞)

---

### 5. –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
**–ö–æ–¥:**
```python
user['money'] += 2000000  # –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ —Ü–µ–ª—å
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Python –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –Ω–æ –≤ PostgreSQL `INTEGER` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 2.1 –º–ª—Ä–¥

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –Æ–∑–µ—Ä –Ω–∞–∫–æ–ø–∏–ª 2 –º–ª—Ä–¥
- –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—É
- –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BIGINT` –≤ PostgreSQL –≤–º–µ—Å—Ç–æ `INTEGER`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –∏–≥—Ä—ã)

---

### 6. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–µ–π
**–ö–æ–¥:**
```python
if goal_id not in user['completed_goals'] and check_goal_completion(user, goal_id):
    user['completed_goals'].append(goal_id)
    user['money'] += goal['reward_money']
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —Ü–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ü–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û–±–∞ –≤–∏–¥—è—Ç —á—Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- –û–±–∞ –¥–æ–±–∞–≤–ª—è—é—Ç –≤ completed_goals
- –û–±–∞ –¥–∞—é—Ç –Ω–∞–≥—Ä–∞–¥—É
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞

**–†–µ—à–µ–Ω–∏–µ:** 
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î –Ω–∞ (user_id, goal_id)
- –ò–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ user_id
**–ö–æ–¥:**
```python
user_id = data.get('user_id')
if user_id not in users_data:
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `user_id` –º–æ–∂–µ—Ç –±—ã—Ç—å `None`, –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º

**–°—Ü–µ–Ω–∞—Ä–∏–π:** 
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `user_id = "' OR '1'='1"`
- –ò–ª–∏ `user_id = "A" * 1000000` (DoS)

**–†–µ—à–µ–Ω–∏–µ:**
```python
import re

def validate_user_id(user_id):
    if not user_id or not isinstance(user_id, str):
        return False
    if len(user_id) > 100:
        return False
    if not re.match(r'^[a-zA-Z0-9_-]+$', user_id):
        return False
    return True
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö†Ô∏è –í–´–°–û–ö–ò–ô

---

### 8. –ù–µ—Ç –ª–∏–º–∏—Ç–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–µ–¥–∏—Ç–æ–≤
**–ö–æ–¥:**
```python
user['credits'].append(credit)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –Æ–∑–µ—Ä –º–æ–∂–µ—Ç –≤–∑—è—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ë–µ—Ä–µ—Ç 1000 –∫—Ä–µ–¥–∏—Ç–æ–≤
- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ = –º–∏–ª–ª–∏–æ–Ω—ã
- –î–µ–Ω—å–≥–∏ —É—Ö–æ–¥—è—Ç –≤ –º–∏–Ω—É—Å
- –ò–≥—Ä–∞ —Å–ª–æ–º–∞–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
MAX_CREDITS = 5
if len(user.get('credits', [])) >= MAX_CREDITS:
    return jsonify({"error": "–ú–∞–∫—Å–∏–º—É–º –∫—Ä–µ–¥–∏—Ç–æ–≤: 5"}), 400
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö†Ô∏è –í–´–°–û–ö–ò–ô

---

### 9. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
**–ö–æ–¥:**
```python
user['mood'] = min(100, user.get('mood', 50) + 10)
user['health'] = min(100, user.get('health', 100) + 15)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ï—Å—Ç—å `min(100, ...)` –¥–ª—è –º–∞–∫—Å–∏–º—É–º–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –º–∏–Ω–∏–º—É–º –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü—Ä—è–º–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `user['mood'] = -1000`

**–†–µ—à–µ–Ω–∏–µ:**
```python
def clamp(value, min_val, max_val):
    return max(min_val, min(max_val, value))

user['mood'] = clamp(user.get('mood', 50) + 10, 0, 100)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

### 10. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
**–ö–æ–¥:**
```python
@app.route('/api/buy_car', methods=['POST'])
def buy_car():  # –ù–µ—Ç @limiter.limit
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ —Å–ø–∞–º–∏—Ç—å –ø–æ–∫—É–ø–∫–∞–º–∏, —Å–æ–∑–¥–∞–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```python
@app.route('/api/buy_car', methods=['POST'])
@limiter.limit("10 per minute")
def buy_car():
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞:**
- `/api/buy_car`
- `/api/buy_real_estate`
- `/api/buy_booster`
- `/api/buy_food`
- `/api/take_rest`
- `/api/random_event`
- `/api/play_roulette`
- `/api/upgrade_skill`
- `/api/next_day`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö†Ô∏è –í–´–°–û–ö–ò–ô

---

### 11. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ë–î
**–ö–æ–¥:**
```python
conn = psycopg2.connect(DATABASE_URL)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫—Ä–∞—à–∏—Ç—Å—è

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ë–î –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç —Å 500
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –∏–≥—Ä–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```python
import time

def connect_with_retry(max_retries=3):
    for i in range(max_retries):
        try:
            return psycopg2.connect(DATABASE_URL)
        except Exception as e:
            if i == max_retries - 1:
                logger.error(f"Failed to connect to DB: {e}")
                # Fallback to SQLite
                return None
            time.sleep(1)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö†Ô∏è –í–´–°–û–ö–ò–ô

---

## üü¢ –ú–ï–õ–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 12. –ù–µ—Ç –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ –≤ –ë–î

**–†–µ—à–µ–Ω–∏–µ:** Cron job –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —é–∑–µ—Ä–æ–≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö >90 –¥–Ω–µ–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô

---

### 13. –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
**–ö–æ–¥:**
```python
user['money'] += 2000000  # –ù–µ—Ç –ª–æ–≥–∞
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —á–∏—Ç–µ—Ä—Å—Ç–≤–æ –∏–ª–∏ –±–∞–≥–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
logger.info(f"User {user_id} received goal reward: {goal['reward_money']}‚ÇΩ")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô

---

### 14. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `user_data` –∏–∑–º–µ–Ω–∏—Ç—Å—è, —Å—Ç–∞—Ä—ã–µ —é–∑–µ—Ä—ã —Å–ª–æ–º–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** 
```python
user_data = {
    'version': 2,  # –í–µ—Ä—Å–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    'money': 500,
    # ...
}

def migrate_user_data(data):
    version = data.get('version', 1)
    if version < 2:
        # –ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ 1 –Ω–∞ 2
        data['new_field'] = default_value
        data['version'] = 2
    return data
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô

---

### 15. –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —á–∏—Ç–µ—Ä—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
**–ö–æ–¥:**
```python
current_time - user['last_event_time'] > 30
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è `time.time()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç (—É–∂–µ –∑–∞—â–∏—â–µ–Ω–æ)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚úÖ –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø

---

## üìã –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å—Ä–æ—á–Ω–æ)
1. ‚úÖ PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
2. ‚ùå –£–±—Ä–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à `users_data` ‚Üí —á–∏—Ç–∞—Ç—å –∏–∑ –ë–î –∫–∞–∂–¥—ã–π —Ä–∞–∑
3. ‚ùå –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–Ω–µ–≥ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. ‚ùå –ó–∞—â–∏—Ç–∏—Ç—å –æ—Ç race conditions –≤ —ç–Ω–µ—Ä–≥–∏–∏ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
5. ‚ùå –ó–∞—â–∏—Ç–∏—Ç—å –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–µ–π (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å)
6. ‚ùå –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø `money` –Ω–∞ BIGINT –≤ PostgreSQL

### –§–∞–∑–∞ 2: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)
7. ‚ùå –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `user_id`
8. ‚ùå –õ–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–º–∞–∫—Å 5)
9. ‚ùå Rate limiting –Ω–∞ –≤—Å–µ POST —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
10. ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ë–î —Å retry

### –§–∞–∑–∞ 3: –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞)
11. ‚ùå –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `clamp()` –¥–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
12. ‚ùå –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
13. ‚ùå –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –§–∞–∑–∞ 4: –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è)
14. ‚ùå Cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
15. ‚ùå –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

---

## üõ†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ö–∞–∫ —É–±—Ä–∞—Ç—å –∫—ç—à users_data

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
users_data = {}  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à

def get_user_data_safe(user_id):
    with cache_lock:
        if user_id not in users_data:
            db_data = load_user_data(user_id)
            users_data[user_id] = db_data
        return users_data[user_id]
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
def get_user_data_safe(user_id):
    """–í—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º –∏–∑ –ë–î - –Ω–µ—Ç –∫—ç—à–∞"""
    db_data = load_user_data(user_id)
    if not db_data:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_data = create_new_user()
        save_user_data(user_id, db_data)
    
    # –í–ê–ñ–ù–û: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º max_energy –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if 'max_energy' not in db_data or db_data['max_energy'] < 100:
        db_data['max_energy'] = 100
        save_user_data(user_id, db_data)
    
    return db_data
```

**–ü–ª—é—Å—ã:**
- –ù–µ—Ç race conditions –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏
- –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–æ—â–µ –∫–æ–¥

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (–Ω–æ PostgreSQL –±—ã—Å—Ç—Ä—ã–π)

---

### –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–Ω–µ–≥

**–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏:**
```python
# –ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–µ–Ω—å–≥–∞–º–∏
if user['money'] < 0:
    logger.error(f"User {user_id} money went negative: {user['money']}")
    user['money'] = 0  # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º
    save_user_data(user_id, user)
    return jsonify({"error": "Transaction failed"}), 500
```

---

### –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –æ—Ç race conditions –≤ —ç–Ω–µ—Ä–≥–∏–∏

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**
```python
# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
old_energy = user['energy']

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤—ã—á–∏—Ç–∞–µ–º
if user['energy'] < energy_cost:
    return error
user['energy'] -= energy_cost

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
save_user_data(user_id, user)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª —ç–Ω–µ—Ä–≥–∏—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
fresh_data = load_user_data(user_id)
if fresh_data['energy'] != user['energy']:
    # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º
    user['energy'] = old_energy
    save_user_data(user_id, user)
    return jsonify({"error": "Concurrent modification, try again"}), 409
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î**
```python
# PostgreSQL
cursor.execute('''
    UPDATE users 
    SET data = jsonb_set(data, '{energy}', to_jsonb((data->>'energy')::int - %s))
    WHERE user_id = %s 
    AND (data->>'energy')::int >= %s
    RETURNING data
''', (energy_cost, user_id, energy_cost))
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º –Ω–∞–π–¥–µ–Ω–æ:** 15
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö:** 6 üî¥
- **–°—Ä–µ–¥–Ω–∏—Ö:** 5 üü°
- **–ú–µ–ª–∫–∏—Ö:** 4 üü¢

**–û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 4/10

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö:** 7/10

**–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 9/10

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. –û–±—Å—É–¥–∏—Ç—å —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ —Ç—Ä–µ–∫–µ—Ä–µ
3. –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
5. –î–µ–ø–ª–æ–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

---

**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** Kiro AI  
**–î–∞—Ç–∞:** 28 —è–Ω–≤–∞—Ä—è 2026  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
